{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0075dbb9be9704823"
      },
      "us-east-2": {
        "AMI": "ami-0d5af8040befff36c"
      },
      "us-west-1": {
        "AMI": "ami-0b20ebeb96908bd8a"
      },
      "us-west-2": {
        "AMI": "ami-055c21d61a5ef83b5"
      },
      "ca-central-1": {
        "AMI": "ami-07ca36f5c88956ecf"
      },
      "eu-central-1": {
        "AMI": "ami-08e8034e4067f9e5b"
      },
      "eu-west-1": {
        "AMI": "ami-006fc57647f3bd811"
      },
      "eu-west-2": {
        "AMI": "ami-0734f40b1e2fe4121"
      },
      "eu-west-3": {
        "AMI": "ami-055e8519c70c454dc"
      },
      "eu-north-1": {
        "AMI": "ami-0672540242fa3ab24"
      },
      "sa-east-1": {
        "AMI": "ami-095568a55773fbe04"
      },
      "me-south-1": {
        "AMI": "ami-0a24cc54dab575459"
      },
      "ap-east-1": {
        "AMI": "ami-08e6d1677cf634c45"
      },
      "ap-south-1": {
        "AMI": "ami-0fc9038e3618db73d"
      },
      "ap-northeast-1": {
        "AMI": "ami-06deebe31db97c02b"
      },
      "ap-northeast-2": {
        "AMI": "ami-0e3d67921373dd733"
      },
      "ap-southeast-1": {
        "AMI": "ami-06687afefaa7cc792"
      },
      "ap-southeast-2": {
        "AMI": "ami-040fd3cdf8fd2ba0d"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "cloudwatch-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      ":",
                      [
                        "arn:aws:logs",
                        {
                          "Ref": "AWS::Region"
                        },
                        {
                          "Ref": "AWS::AccountId"
                        },
                        "log-group",
                        {
                          "Fn::Join": [
                            "-",
                            [
                              {
                                "Ref": "AWS::StackName"
                              },
                              {
                                "Fn::Select": [
                                  "2",
                                  {
                                    "Fn::Split": [
                                      "/",
                                      {
                                        "Ref": "AWS::StackId"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          ]
                        },
                        "*"
                      ]
                    ]
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:s3:::dcv-license.",
                        {
                          "Ref": "AWS::Region"
                        },
                        "/*"
                      ]
                    ]
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "PredefinedRole"
          }
        ]
      }
    },
    "MATLABInstanceProfileCustom": {
      "Type": "AWS::IAM::InstanceProfile",
      "Condition": "UseCustomIamRole",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "CustomIamRole"
          }
        ]
      }
    },
    "MATLABSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH and RDP Access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "3389",
            "ToPort": "3389",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "8443",
            "ToPort": "8443",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          }
        ]
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Ref": "MATLABSecurityGroup"
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "IamInstanceProfile": {
          "Fn::If": [
            "UsePredefinedRole",
            {
              "Ref": "MATLABInstanceProfile"
            },
            {
              "Fn::If": [
                "UseCustomIamRole",
                {
                  "Ref": "MATLABInstanceProfileCustom"
                },
                {
                  "Ref": "AWS::NoValue"
                }
              ]
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "# Copyright 2011-2020 The MathWorks, Inc.\n",
                "cd /usr/local/matlab\n",
                "sudo echo $PATH:/usr/local/matlab/bin | sudo tee /etc/environment > /dev/null\n",
                "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                "echo \"",
                {
                  "Fn::Join": [
                    ":",
                    [
                      "ubuntu",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "$(echo \"",
                            {
                              "Fn::Base64": {
                                "Ref": "Password"
                              }
                            },
                            "\" | base64 -d)"
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\" | sudo chpasswd",
                "\n",
                "if [ -n '",
                {
                  "Ref": "LicenseManager"
                },
                "' ]\n",
                " then \n",
                "#disable online licensing and enable a license server\n",
                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                "echo 'export MLM_LICENSE_FILE=",
                {
                  "Ref": "LicenseManager"
                },
                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                "\n",
                "fi\n",
                {
                  "Fn::Sub": "export ENABLE_CLOUDWATCH_LOGGING=\"${EnableCloudWatch}\""
                },
                "\n",
                {
                  "Fn::Join": [
                    "=",
                    [
                      "export LOG_GROUP_NAME",
                      {
                        "Fn::Join": [
                          "-",
                          [
                            {
                              "Ref": "AWS::StackName"
                            },
                            {
                              "Fn::Select": [
                                "2",
                                {
                                  "Fn::Split": [
                                    "/",
                                    {
                                      "Ref": "AWS::StackId"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\n",
                "/usr/local/bin/start-logging.sh\n",
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL=\"${AccessProtocol}\"\n"
                },
                "/usr/local/bin/start-desktop.sh\n",
                "/usr/local/bin/aws-cfn-bootstrap-*/bin/cfn-signal -e $? ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource MATLABEC2Instance ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n"
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "MATLABLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "UseCloudWatch",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "AWS::StackName"
              },
              {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Ref": "AWS::StackId"
                      }
                    ]
                  }
                ]
              }
            ]
          ]
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Run script to switch between xrdp and nice dcv.",
              "default": "/usr/local/bin/swap-desktop-solution.sh"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        },
        "DocumentType": "Command",
        "Name": {
          "Fn::Select": [
            "2",
            {
              "Fn::Split": [
                "/",
                {
                  "Ref": "AWS::StackId"
                }
              ]
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": {
            "Fn::Sub": [
              "",
              {
                "INSTANCE_ID": {
                  "Ref": "MATLABEC2Instance"
                },
                "DEFAULT_TIME_INTERVAL": {
                  "Ref": "AutoShutdown"
                }
              }
            ]
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.8",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": [
                      "arn:aws:ec2:${region}:${accountId}:instance/${instanceId}",
                      {
                        "region": {
                          "Ref": "AWS::Region"
                        },
                        "accountId": {
                          "Ref": "AWS::AccountId"
                        },
                        "instanceId": {
                          "Ref": "MATLABEC2Instance"
                        }
                      }
                    ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:logs:",
                        {
                          "Ref": "AWS::Region"
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId"
                        },
                        ":",
                        "log-group:",
                        "/aws/lambda/*"
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Give your MATLAB virtual machine a name",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Specify the access protocol to access this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Choose whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Specify the size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 64 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Specify an IAM Role to associate with this instance.",
      "Default": "",
      "Type": "String"
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "List of existing subnets IDs",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Enter a password for the \"ubuntu\" user",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Choose whether you want to enable cloudwatch logging for the MATLAB instance",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Or": [
              {
                "Fn::Not": [
                  {
                    "Fn::Not": [
                      {
                        "Fn::Equals": [
                          {
                            "Ref": "CustomIamRole"
                          },
                          ""
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "Fn::Equals": [
                  "No",
                  {
                    "Ref": "EnableCloudWatch"
                  }
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use a custom IAM role when using CloudWatch. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Or": [
              {
                "Fn::Not": [
                  {
                    "Fn::Not": [
                      {
                        "Fn::Equals": [
                          {
                            "Ref": "CustomIamRole"
                          },
                          ""
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "Fn::Equals": [
                  "RDP",
                  {
                    "Ref": "AccessProtocol"
                  }
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use a custom IAM role when using NICE DCV. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        "",
        {
          "Ref": "CustomIamRole"
        }
      ]
    },
    "UseCustomIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "",
            {
              "Ref": "CustomIamRole"
            }
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        "Yes",
        {
          "Ref": "EnableCloudWatch"
        }
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        "NICE DCV",
        {
          "Ref": "AccessProtocol"
        }
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        "RDP",
        {
          "Ref": "AccessProtocol"
        }
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        "Yes",
        {
          "Ref": "UseElasticIpAddress"
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  {
                    "Fn::Select": [
                      "2",
                      {
                        "Fn::Split": [
                          "/",
                          {
                            "Ref": "AWS::StackId"
                          }
                        ]
                      }
                    ]
                  }
                ]
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "IAM Role (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        }
      }
    }
  }
}